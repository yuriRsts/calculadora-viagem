<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Calculadora de Viagem</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4a90e2">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  background: #1e1e1e;
  font-family: Arial, sans-serif;
  color: #fff;
}

.container {
  width: 100%;
  max-width: 420px;
  background: #2a2a2a;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.5);
}

h2 {
  text-align: center;
  margin-bottom: 15px;
}

input, button {
  width: 100%;
  height: 46px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #444;
  background: #1f1f1f;
  color: #fff;
  padding: 0 12px;
  font-size: 15px;
}

button {
  background: linear-gradient(135deg, #4a90e2, #357abd);
  border: none;
  cursor: pointer;
  font-weight: bold;
}

button:hover { opacity: .9; }

.resultado {
  background: #1b1b1b;
  border-radius: 8px;
  padding: 10px;
  margin-top: 10px;
  font-size: 14px;
}

#map {
  width: 100%;
  height: 220px;
  border-radius: 10px;
  margin-top: 10px;
  overflow: hidden;
}

.links button {
  margin-top: 8px;
}
</style>
</head>

<body>
<div class="container">
  <h2>Calculadora de Viagem</h2>

  <input id="origem" placeholder="Endere√ßo de origem">
  <input id="destino" placeholder="Endere√ßo de destino">
  <input id="kmLitro" type="number" placeholder="Km por litro">
  <input id="precoGasolina" type="number" step="0.01" placeholder="Pre√ßo da gasolina">
  <input id="pedagioManual" type="number" step="0.01" placeholder="Ped√°gio informado (opcional)">

  <button onclick="calcular()">Calcular</button>

  <div id="resultado" class="resultado"></div>

  <div class="links" id="links"></div>

  <div id="map"></div>

  <div id="historico" class="resultado"></div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiYWC1UozNM6xqegQg__CQvNA3FXgFbEA&libraries=places"></script>

<script>
let service, directionsService, directionsRenderer, map;

function init() {
  service = new google.maps.places.AutocompleteService();
  configurarAutocomplete("origem");
  configurarAutocomplete("destino");

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();

  map = new google.maps.Map(document.getElementById("map"), {
    center: { lat: -23.55, lng: -46.63 },
    zoom: 6,
  });

  directionsRenderer.setMap(map);

  restaurarUltimaRota();
  renderizarHistorico();
}

function configurarAutocomplete(id) {
  const input = document.getElementById(id);
  const lista = document.createElement("div");

  lista.style.position = "absolute";
  lista.style.background = "#1f1f1f";
  lista.style.color = "#fff";
  lista.style.border = "1px solid #444";
  lista.style.borderRadius = "6px";
  lista.style.zIndex = "9999";
  lista.style.display = "none";

  document.body.appendChild(lista);

  input.addEventListener("input", () => {
    const valor = input.value.trim();
    if (valor.length < 3) {
      lista.style.display = "none";
      return;
    }

    const rect = input.getBoundingClientRect();
    lista.style.width = rect.width + "px";
    lista.style.left = rect.left + "px";
    lista.style.top = rect.bottom + window.scrollY + "px";

    service.getPlacePredictions({
      input: valor,
      componentRestrictions: { country: "br" }
    }, (predictions) => {
      if (!predictions) return;

      lista.innerHTML = "";
      predictions.forEach(p => {
        const item = document.createElement("div");
        item.textContent = p.description;
        item.style.padding = "8px";
        item.style.cursor = "pointer";

        item.onclick = () => {
          input.value = p.description;
          lista.style.display = "none";
        };

        lista.appendChild(item);
      });
      lista.style.display = "block";
    });
  });

  document.addEventListener("click", e => {
    if (e.target !== input) lista.style.display = "none";
  });
}

function calcular() {
  const origem = origemInput.value;
  const destino = destinoInput.value;
  const kmLitro = parseFloat(kmLitroInput.value);
  const preco = parseFloat(precoGasolinaInput.value);
  const pedagioManual = parseFloat(pedagioManualInput.value) || 0;

  if (!origem || !destino || !kmLitro || !preco) {
    alert("Preencha todos os campos obrigat√≥rios.");
    return;
  }

  directionsService.route({
    origin: origem,
    destination: destino,
    travelMode: "DRIVING"
  }, (result, status) => {
    if (status !== "OK") {
      alert("Erro ao calcular rota.");
      return;
    }

    directionsRenderer.setDirections(result);

    const leg = result.routes[0].legs[0];
    const distanciaKm = leg.distance.value / 1000;
    const tempo = leg.duration.text;

    const litros = distanciaKm / kmLitro;
    const custoCombustivel = litros * preco;

    const pedagioEstimado = distanciaKm * 0.15;
    const total = custoCombustivel + pedagioEstimado + pedagioManual;

    resultado.innerHTML = `
      üìè Dist√¢ncia: ${distanciaKm.toFixed(2)} km<br>
      ‚è± Tempo estimado: ${tempo}<br>
      ‚õΩ Combust√≠vel: R$ ${custoCombustivel.toFixed(2)}<br>
      üõ£ Ped√°gio estimado: R$ ${pedagioEstimado.toFixed(2)}<br>
      üßæ Ped√°gio informado: R$ ${pedagioManual.toFixed(2)}<br>
      üí∞ <b>Total estimado: R$ ${total.toFixed(2)}</b>
    `;

    links.innerHTML = `
      <button onclick="window.open('https://www.google.com/maps/dir/?api=1&origin=${encodeURIComponent(origem)}&destination=${encodeURIComponent(destino)}')">
        üó∫ Abrir no Google Maps
      </button>
      <button onclick="window.open('https://waze.com/ul?ll=${leg.end_location.lat()},${leg.end_location.lng()}&navigate=yes')">
        üöó Abrir no Waze
      </button>
    `;

    salvarUltimaRota(origem, destino, kmLitro, preco, pedagioManual);
    salvarHistorico(origem, destino, distanciaKm, total);
    renderizarHistorico();
  });
}

function salvarUltimaRota(...dados) {
  localStorage.setItem("ultimaRota", JSON.stringify(dados));
}

function restaurarUltimaRota() {
  const dados = JSON.parse(localStorage.getItem("ultimaRota"));
  if (!dados) return;

  origem.value = dados[0];
  destino.value = dados[1];
  kmLitro.value = dados[2];
  precoGasolina.value = dados[3];
  pedagioManual.value = dados[4];
}

function salvarHistorico(origem, destino, distancia, total) {
  const hist = JSON.parse(localStorage.getItem("historico")) || [];
  hist.unshift({ origem, destino, distancia, total, data: new Date().toLocaleString() });
  localStorage.setItem("historico", JSON.stringify(hist.slice(0, 5)));
}

function renderizarHistorico() {
  const hist = JSON.parse(localStorage.getItem("historico")) || [];
  if (!hist.length) return;

  historico.innerHTML = "<b>üïò Hist√≥rico</b><br><br>" +
    hist.map(h => `
      üìç ${h.origem} ‚Üí ${h.destino}<br>
      üìè ${h.distancia.toFixed(1)} km | üí∞ R$ ${h.total.toFixed(2)}<br>
      üïì ${h.data}<br><br>
    `).join("");
}

window.onload = init;

// PWA
if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

const origemInput = document.getElementById("origem");
const destinoInput = document.getElementById("destino");
const kmLitroInput = document.getElementById("kmLitro");
const precoGasolinaInput = document.getElementById("precoGasolina");
</script>

</body>
</html>
