<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Calculadora de Viagem</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#4a90e2">

<style>
* { box-sizing: border-box; }

body {
  margin: 0;
  min-height: 100vh;
  display: flex;
  justify-content: center;
  align-items: flex-start;
  padding: 20px;
  background: #1e1e1e;
  font-family: Arial, sans-serif;
  color: #fff;
}

.container {
  width: 100%;
  max-width: 420px;
  background: #2a2a2a;
  padding: 20px;
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0,0,0,.5);
}

h2 { text-align: center; }

input, button {
  width: 100%;
  height: 46px;
  margin-bottom: 10px;
  border-radius: 8px;
  border: 1px solid #444;
  background: #1f1f1f;
  color: #fff;
  padding: 0 12px;
}

button {
  background: linear-gradient(135deg,#4a90e2,#357abd);
  border: none;
  font-weight: bold;
  cursor: pointer;
}

.resultado {
  background: #1b1b1b;
  padding: 10px;
  border-radius: 8px;
  font-size: 14px;
}

#map {
  width: 100%;
  height: 220px;
  border-radius: 10px;
  margin-top: 10px;
}
</style>
</head>

<body>
<div class="container">
  <h2>Calculadora de Viagem</h2>

  <input id="origem" placeholder="Endere√ßo de origem">
  <input id="destino" placeholder="Endere√ßo de destino">
  <input id="kmLitro" type="number" placeholder="Km por litro">
  <input id="precoGasolina" type="number" step="0.01" placeholder="Pre√ßo da gasolina">
  <input id="pedagio" type="number" step="0.01" placeholder="Ped√°gio (opcional)">

  <button onclick="calcular()">Calcular</button>

  <button id="btnInstall" style="display:none;">üì≤ Instalar App</button>

  <div id="resultado" class="resultado"></div>
  <div id="map"></div>
  <div id="historico" class="resultado"></div>
</div>

<script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyDiYWC1UozNM6xqegQg__CQvNA3FXgFbEA&libraries=places"></script>

<script>
let map, directionsService, directionsRenderer, service;
let deferredPrompt = null;

// INPUTS CORRETOS
const origemInput = document.getElementById("origem");
const destinoInput = document.getElementById("destino");
const kmLitroInput = document.getElementById("kmLitro");
const precoGasolinaInput = document.getElementById("precoGasolina");
const pedagioInput = document.getElementById("pedagio");

function init() {
  service = new google.maps.places.AutocompleteService();

  configurarAutocomplete(origemInput);
  configurarAutocomplete(destinoInput);

  directionsService = new google.maps.DirectionsService();
  directionsRenderer = new google.maps.DirectionsRenderer();

  map = new google.maps.Map(document.getElementById("map"), {
    zoom: 6,
    center: { lat: -23.55, lng: -46.63 }
  });

  directionsRenderer.setMap(map);
  restaurarUltimaRota();
  renderizarHistorico();
}

function configurarAutocomplete(input) {
  const lista = document.createElement("div");
  lista.style.position = "absolute";
  lista.style.background = "#1f1f1f";
  lista.style.color = "#fff";
  lista.style.border = "1px solid #444";
  lista.style.zIndex = "9999";
  lista.style.display = "none";
  document.body.appendChild(lista);

  input.addEventListener("input", () => {
    const valor = input.value.trim();
    if (valor.length < 3) {
      lista.style.display = "none";
      return;
    }

    const rect = input.getBoundingClientRect();
    lista.style.width = rect.width + "px";
    lista.style.left = rect.left + "px";
    lista.style.top = rect.bottom + window.scrollY + "px";

    service.getPlacePredictions(
      { input: valor, componentRestrictions: { country: "br" } },
      (predictions) => {
        if (!predictions) return;
        lista.innerHTML = "";
        predictions.forEach(p => {
          const item = document.createElement("div");
          item.textContent = p.description;
          item.style.padding = "8px";
          item.onclick = () => {
            input.value = p.description;
            lista.style.display = "none";
          };
          lista.appendChild(item);
        });
        lista.style.display = "block";
      }
    );
  });
}

function calcular() {
  const origem = origemInput.value;
  const destino = destinoInput.value;
  const kmLitro = parseFloat(kmLitroInput.value);
  const preco = parseFloat(precoGasolinaInput.value);
  const pedagio = parseFloat(pedagioInput.value) || 0;

  if (!origem || !destino || !kmLitro || !preco) {
    alert("Preencha todos os campos obrigat√≥rios.");
    return;
  }

  directionsService.route(
    { origin: origem, destination: destino, travelMode: "DRIVING" },
    (result, status) => {
      if (status !== "OK") return alert("Erro ao calcular rota.");

      directionsRenderer.setDirections(result);
      const leg = result.routes[0].legs[0];

      const km = leg.distance.value / 1000;
      const tempo = leg.duration.text;
      const combustivel = (km / kmLitro) * preco;
      const pedagioEstimado = km * 0.15;
      const total = combustivel + pedagioEstimado + pedagio;

      resultado.innerHTML = `
        üìè ${km.toFixed(2)} km<br>
        ‚è± ${tempo}<br>
        ‚õΩ R$ ${combustivel.toFixed(2)}<br>
        üõ£ Ped√°gio estimado: R$ ${pedagioEstimado.toFixed(2)}<br>
        üí∞ <b>Total: R$ ${total.toFixed(2)}</b>
      `;

      salvarUltimaRota();
      salvarHistorico(origem, destino, km, total);
      renderizarHistorico();
    }
  );
}

// LOCALSTORAGE
function salvarUltimaRota() {
  localStorage.setItem("ultimaRota", JSON.stringify({
    origem: origemInput.value,
    destino: destinoInput.value,
    km: kmLitroInput.value,
    preco: precoGasolinaInput.value,
    pedagio: pedagioInput.value
  }));
}

function restaurarUltimaRota() {
  const r = JSON.parse(localStorage.getItem("ultimaRota"));
  if (!r) return;
  origemInput.value = r.origem;
  destinoInput.value = r.destino;
  kmLitroInput.value = r.km;
  precoGasolinaInput.value = r.preco;
  pedagioInput.value = r.pedagio;
}

function salvarHistorico(o,d,k,t) {
  const h = JSON.parse(localStorage.getItem("historico")) || [];
  h.unshift({ o,d,k,t,data:new Date().toLocaleString() });
  localStorage.setItem("historico", JSON.stringify(h.slice(0,5)));
}

function renderizarHistorico() {
  const h = JSON.parse(localStorage.getItem("historico")) || [];
  historico.innerHTML = h.length ? "<b>üïò Hist√≥rico</b><br><br>" +
    h.map(i=>`${i.o} ‚Üí ${i.d}<br>R$ ${i.t.toFixed(2)}<br><br>`).join("") : "";
}

// PWA INSTALL
window.addEventListener("beforeinstallprompt", e => {
  e.preventDefault();
  deferredPrompt = e;
  btnInstall.style.display = "block";
});

btnInstall.onclick = async () => {
  deferredPrompt.prompt();
  deferredPrompt = null;
  btnInstall.style.display = "none";
};

if ("serviceWorker" in navigator) {
  navigator.serviceWorker.register("sw.js");
}

window.onload = init;
</script>
</body>
</html>
